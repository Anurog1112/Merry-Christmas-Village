<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ρ(x), E(x), V(x) with Labels</title>
<style>
  body { font-family: "Segoe UI", sans-serif; display: flex; flex-direction: column; align-items: center; }
  .chart-container {
    border: 1px solid #ddd;
    padding: 15px;
    margin: 15px;
    border-radius: 8px;
    background: #fdfdfd;
    text-align: center;
  }
  svg { border: 1px solid #ccc; background: #fafafa; }
  button {
    margin: 5px;
    padding: 8px 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover { background-color: #e0e0e0; }
  .axis { stroke: black; stroke-width: 1; }
  .rho { stroke: #d62728; fill: rgba(214,39,40,0.15); }
  .E   { stroke: #1f77b4; fill: rgba(31,119,180,0.15); }
  .V   { stroke: #2ca02c; fill: none; stroke-width: 2; }
  text { font-size: 12px; }
  .annotation { font-size: 13px; font-style: italic; }
  marker { overflow: visible; }
</style>
</head>
<body>
<h2>Depletion Approximation: ρ(x), E(x), V(x)</h2>

<div class="chart-container">
  <svg id="rho" width="700" height="200"></svg>
  <div>
    <button onclick="downloadSVG('rho', 'charge_density.svg')">Download as SVG</button>
    <button onclick="downloadPNG('rho', 'charge_density.png')">Download as PNG</button>
    <button onclick="downloadJPG('rho', 'charge_density.jpg')">Download as JPG</button>
    <button onclick="resetZoom('rho')">Reset Zoom</button>
  </div>
</div>
<div class="chart-container">
  <svg id="Efield" width="700" height="200"></svg>
  <div>
    <button onclick="downloadSVG('Efield', 'electric_field.svg')">Download as SVG</button>
    <button onclick="downloadPNG('Efield', 'electric_field.png')">Download as PNG</button>
    <button onclick="downloadJPG('Efield', 'electric_field.jpg')">Download as JPG</button>
    <button onclick="resetZoom('Efield')">Reset Zoom</button>
  </div>
</div>
<div class="chart-container">
  <svg id="Vpot" width="700" height="200"></svg>
  <div>
    <button onclick="downloadSVG('Vpot', 'electric_potential.svg')">Download as SVG</button>
    <button onclick="downloadPNG('Vpot', 'electric_potential.png')">Download as PNG</button>
    <button onclick="downloadJPG('Vpot', 'electric_potential.jpg')">Download as JPG</button>
    <button onclick="resetZoom('Vpot')">Reset Zoom</button>
  </div>
</div>

<script>
function getSvgWithWhiteBackground(svgId) {
  const svg = document.getElementById(svgId);
  const clone = svg.cloneNode(true);
  
  const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  rect.setAttribute("width", "100%");
  rect.setAttribute("height", "100%");
  rect.setAttribute("fill", "white");
  clone.insertBefore(rect, clone.firstChild);
  
  return clone;
}

function downloadSVG(svgId, filename) {
  const svgClone = getSvgWithWhiteBackground(svgId);
  const serializer = new XMLSerializer();
  let source = serializer.serializeToString(svgClone);

  if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
  }
  if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
  }

  source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

  const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
  const downloadLink = document.createElement("a");
  downloadLink.href = url;
  downloadLink.download = filename;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
}

function downloadPNG(svgId, filename) {
  const svgClone = getSvgWithWhiteBackground(svgId);
  const serializer = new XMLSerializer();
  let source = serializer.serializeToString(svgClone);
  const svgBlob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = function() {
      const canvas = document.createElement('canvas');
      const svg = document.getElementById(svgId);
      const scale = 2; // Increase scale for higher resolution
      canvas.width = (svg.getAttribute('width') || 300) * scale;
      canvas.height = (svg.getAttribute('height') || 150) * scale;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      
      const pngUrl = canvas.toDataURL('image/png');
      const downloadLink = document.createElement("a");
      downloadLink.href = pngUrl;
      downloadLink.download = filename;
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
  };
  img.src = url;
}

function downloadJPG(svgId, filename) {
  const svgClone = getSvgWithWhiteBackground(svgId);
  const serializer = new XMLSerializer();
  let source = serializer.serializeToString(svgClone);
  const svgBlob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = function() {
      const canvas = document.createElement('canvas');
      const svg = document.getElementById(svgId);
      const scale = 2; // Increase scale for higher resolution
      canvas.width = (svg.getAttribute('width') || 300) * scale;
      canvas.height = (svg.getAttribute('height') || 150) * scale;
      
      const ctx = canvas.getContext('2d');
      // JPG does not support transparency, so we must fill the background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      
      // Get JPG data URL with quality setting
      const jpgUrl = canvas.toDataURL('image/jpeg', 0.9);
      const downloadLink = document.createElement("a");
      downloadLink.href = jpgUrl;
      downloadLink.download = filename;
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
  };
  img.src = url;
}

function enableZoomAndPan(svgId) {
    const svg = document.getElementById(svgId);
    const g = svg.querySelector('g');
    if (!g) return;

    let scale = 1;
    let panX = 0;
    let panY = 0;
    let isPanning = false;
    let startPoint = { x: 0, y: 0 };

    const updateTransform = () => {
        g.setAttribute('transform', `translate(${panX}, ${panY}) scale(${scale})`);
    };

    svg.addEventListener('wheel', (e) => {
        e.preventDefault();
        const zoomFactor = 1.1;
        const { clientX, clientY } = e;
        const svgRect = svg.getBoundingClientRect();
        
        const x = clientX - svgRect.left;
        const y = clientY - svgRect.top;

        const oldScale = scale;
        if (e.deltaY < 0) {
            scale *= zoomFactor;
        } else {
            scale /= zoomFactor;
        }
        
        panX = x - (x - panX) * (scale / oldScale);
        panY = y - (y - panY) * (scale / oldScale);

        updateTransform();
    });

    svg.addEventListener('mousedown', (e) => {
        isPanning = true;
        startPoint = { x: e.clientX - panX, y: e.clientY - panY };
        svg.style.cursor = 'grabbing';
    });

    svg.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        panX = e.clientX - startPoint.x;
        panY = e.clientY - startPoint.y;
        updateTransform();
    });

    const stopPanning = () => {
        isPanning = false;
        svg.style.cursor = 'grab';
    };

    svg.addEventListener('mouseup', stopPanning);
    svg.addEventListener('mouseleave', stopPanning);
    svg.style.cursor = 'grab';
}

function resetZoom(svgId) {
    const svg = document.getElementById(svgId);
    const g = svg.querySelector('g');
    if (g) {
        g.setAttribute('transform', 'translate(0, 0) scale(1)');
        // Re-apply the zoom/pan logic with reset values
        enableZoomAndPan(svgId);
    }
}

// Parameters
const xp = 1.0, xn = 1.0;   // depletion widths (normalized units)
const NA = 1, ND = 1;       // assume NA=ND
const Vbi = 1.0;            // built-in potential

function mapper(svg, xRange, yRange){
  const W = svg.getAttribute("width"), H = svg.getAttribute("height");
  return {
    X: x => (x - xRange[0])/(xRange[1]-xRange[0])*W,
    Y: y => H - (y - yRange[0])/(yRange[1]-yRange[0])*H
  };
}

// ---------- ρ(x) ----------
(function(){
  const svg = document.getElementById("rho");
  const map = mapper(svg, [-1.5,1.5], [-1.2,1.2]);

  svg.innerHTML = `<g><line class="axis" x1="${map.X(-1.5)}" y1="${map.Y(0)}" x2="${map.X(1.5)}" y2="${map.Y(0)}"/>`;

  // negative block
  let path = `M${map.X(-xp)},${map.Y(0)} L${map.X(0)},${map.Y(0)} L${map.X(0)},${map.Y(-1)} L${map.X(-xp)},${map.Y(-1)} Z`;
  svg.querySelector('g').innerHTML += `<path d="${path}" class="rho"/>`;
  // positive block
  path = `M${map.X(0)},${map.Y(0)} L${map.X(xn)},${map.Y(0)} L${map.X(xn)},${map.Y(1)} L${map.X(0)},${map.Y(1)} Z`;
  svg.querySelector('g').innerHTML += `<path d="${path}" class="rho"/>`;

  svg.querySelector('g').innerHTML += `<text x="${map.X(-0.5)}" y="${map.Y(-1.05)}" class="annotation" fill="#d62728">ประจุลบคงที่ (-qN_A)</text>`;
  svg.querySelector('g').innerHTML += `<text x="${map.X(0.5)}" y="${map.Y(1.15)}" class="annotation" fill="#d62728">ประจุบวกคงที่ (+qN_D)</text>`;
  svg.querySelector('g').innerHTML += `<text x="10" y="15">ρ(x)</text></g>`;
  enableZoomAndPan("rho");
})();

// ---------- E(x) ----------
(function(){
  const svg = document.getElementById("Efield");
  const map = mapper(svg, [-1.5,1.5], [-1.2,1.2]);

  svg.innerHTML = `<g><line class="axis" x1="${map.X(-1.5)}" y1="${map.Y(0)}" x2="${map.X(1.5)}" y2="${map.Y(0)}"/>`;

  let path = `M${map.X(-xp)},${map.Y(0)} L${map.X(0)},${map.Y(-1)} L${map.X(xn)},${map.Y(0)} Z`;
  svg.querySelector('g').innerHTML += `<path d="${path}" class="E"/>`;

  // annotation
  svg.querySelector('g').innerHTML += `<text x="${map.X(0)}" y="${map.Y(-1.1)}" class="annotation" fill="#1f77b4" text-anchor="middle">E(x) ต่ำสุดที่ x=0</text>`;
  svg.querySelector('g').innerHTML += `<text x="10" y="15">E(x)</text></g>`;
  enableZoomAndPan("Efield");
})();

// ---------- V(x) ----------
(function(){
  const svg = document.getElementById("Vpot");
  const map = mapper(svg, [-1.5,1.5], [0,1.2]);

  svg.innerHTML = `<g><line class="axis" x1="${map.X(-1.5)}" y1="${map.Y(0)}" x2="${map.X(1.5)}" y2="${map.Y(0)}"/>`;

  const N = 100;
  let d = "";
  for(let i=0;i<=N;i++){
    let x = -xp + 2*xp*i/N;
    let Vx = Vbi * ( (x+xp)/(xp+xn) ) * (1 - (x+xp)/(xp+xn) );
    let X = map.X(x), Y = map.Y(Vx);
    d += (i==0?`M${X},${Y}`:` L${X},${Y}`);
  }
  svg.querySelector('g').innerHTML += `<path d="${d}" class="V"/>`;

  svg.querySelector('g').innerHTML += `<line x1="${map.X(-1.5)}" y1="${map.Y(0)}" x2="${map.X(-xp)}" y2="${map.Y(0)}" stroke="#2ca02c"/>`;
  svg.querySelector('g').innerHTML += `<line x1="${map.X(xn)}" y1="${map.Y(Vbi)}" x2="${map.X(1.5)}" y2="${map.Y(Vbi)}" stroke="#2ca02c"/>`;

  svg.querySelector('g').innerHTML += `<text x="${map.X(-1.2)}" y="${map.Y(0.05)}" fill="#2ca02c">V=0</text>`;
  svg.querySelector('g').innerHTML += `<text x="${map.X(1.2)}" y="${map.Y(Vbi)+15}" fill="#2ca02c">V=V_bi</text>`;
  svg.querySelector('g').innerHTML += `<text x="${map.X(0)}" y="${map.Y(0.55)}" class="annotation" fill="#2ca02c" text-anchor="middle">ศักย์ไฟฟ้าเพิ่มขึ้นจาก 0 → Vbi</text>`;
  svg.querySelector('g').innerHTML += `<text x="10" y="15">V(x)</text></g>`;
  enableZoomAndPan("Vpot");
})();
</script>
</body>
</html>
